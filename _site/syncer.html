<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>LowlaDB Documentation</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles -->
    <link href="css/lowladocs.css" rel="stylesheet">
    <link href="css/syntax.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="container">

      <!-- Static navbar -->
      <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">LowlaDB</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li id="navqs"><a href="qs.html">Quick Start</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Clients<span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li><a href="browser.html">Browser</a></li>
                  <li><a href="#">Command Line</a></li>
                </ul>
              </li>
			  <li id="navsyncer"><a href="syncer.html">Syncer</a></li>
              <li id="navadapter"><a href="adapter.html">Adapter</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container-fluid -->
      </nav>

      <!-- Main component -->
      <div class="jumbotron">
		  <h2>LowlaDB Syncer</h2>
		  <p>The LowlaDB Syncer keeps track of modifications to documents and tells LowlaDB clients when they need to sync and what data needs updating.</p>
      </div>
	  
	  <div class="container">
		  <div class="row">
			  <nav class="col-sm-3 bs-docs-sidebar">
				  
				  <ul class="nav nav-stacked fixed">
	<li>
		<a href="#Intro">Introduction</a>
	</li>
	<li>
		<a href="#Install">Installation</a>
	</li>
	<li>
		<a href="#Spec">Specification</a>
		<ul class="nav nav-stacked">
			<li><a href="#SpecDefs">Definitions</a></li>
			<li><a href="#SpecClient">Client</a></li>
			<li><a href="#SpecAdapter">Adapter</a></li>
		</ul>
	</li>
	<li>
		<a href="#API">API</a>
	</li>
</ul>
				  
			  </nav>
			  <div class="col-sm-9">
				  <p><a name="Intro"></a></p>

<h2 id="introduction">Introduction</h2>
<p>The LowlaDB syncer acts as a intermediary between LowlaDB clients and adapters. Its role is to keep track of modifications to documents so that adapters can focus on the specifics of talking to their back-end while the syncer takes care of the housekeeping. It also provides a natural central point for notifying clients when data has changed. This allows push-style notifications using e.g., socket.io or Apple Push Notifications for real-time or near real-time applications again with no changes required to any adapters.</p>

<p>LowlaDB includes a default implementation of the syncer that can be embedded within a Node.js application and stores its data in MongoDB. This implementation has a simple API that allows you to hook document modifications and trigger client notifications. </p>

<h5 id="notes">Notes</h5>
<ul>
  <li>Once the syncer has notified a client that new data is available, the client connects directly to the adapter to pull the data. Data created or modified on the client is again sent directly to the adapter. No data (other than document identifiers and document version identifiers) is ever sent to or through the syncer.</li>
  <li>This allows the syncer to be hosted in a less secure environment than the adapter, providing more options for scaling the syncer independently of the adapter. This is valuable in situations where clients are polling the syncer for changes, but changes happen infrequently. The syncer can be scaled to handle the polling and the adapters only need handle the load when changes have occurred.</li>
</ul>

<p><a name="Spec"></a></p>

<h2 id="specification">Specification</h2>
<p>The LowlaDB client, syncer and adapter all communicate via a simple HTTP-based protocol. This section defines the parts of the protocol that the syncer implements.</p>

<p><a name="SpecDefs"></a></p>

<h4 id="definitions">Definitions</h4>
<dl>
  <dt>ID</dt>
  <dd>A text identifier that uniquely identifies a document. IDs are generated by adapters and, for new records created remotely, by clients.</dd>
  <dt>Version</dt>
  <dd>A text identifier for a particular version of a document. Versions are only ever compared for equality, they do not need to support any kind of ordering. The only requirement is that the version must change when a document changes. Typical implementations include</dd>
</dl>

<ul>
  <li>an increasing counter</li>
  <li>a hash of the document</li>
  <li>a timestamp
Versions are always generated by adapters.</li>
</ul>

<dl>
  <dt>Sequence</dt>
  <dd>An increasing counter maintained by the syncer to order modifications and identify changes that have occurred since a client last synced.</dd>
  <dt>ClientNs</dt>
  <dd>Client namespace, i.e., the database and collection where a document should be stored on the client. This is expressed in the usual MongoDB form <code>db.collection</code> where collection may itself contain embedded periods.</dd>
</dl>

<p><a name="SpecClient"></a></p>

<h4 id="client">Client</h4>
<p>A LowlaDB client may request modifications starting from a particular sequence by issuing an HTTP GET request to the endpoint</p>

<p><code>
/api/v1/changes?seq=&lt;sequence&gt;
</code></p>

<p>The syncer will generate a response of the form</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;atoms&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> 
      <span class="nt">&quot;sequence&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;sequence&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;version&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;clientNs&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;clientNs&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="err">|</span><span class="kc">false</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="err">...</span><span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;sequence&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;sequence that client should use for next request&gt;&quot;</span>
<span class="p">}</span></code></pre></div>

<h5 id="notes-1">Notes</h5>
<ul>
  <li>The <code>seq</code> argument is optional; if it is missing the syncer will only respond with the current sequence number.</li>
  <li>Sequence numbers are never negative and so a client can begin to populate an empty database by issuing a <code>changes</code> request with <code>seq=0</code>.</li>
  <li>For performance or scalability reasons, the syncer need not return <em>all</em> atoms since the requested sequence. However, it must return the atoms in sequence order beginning with the oldest (i.e., lowest sequence number.) It must then set the <code>sequence</code> property of the response appropriately so that the client can continue requesting atoms until it has received them all with no gaps. In situations where large numbers of modifications share the same sequence number, this may lead to some atoms being returned more than once. This is unavoidable without generating unique sequence numbers for every modification.</li>
  <li>The value of the <code>sequence</code> property will usually be higher than the maximum sequence value in any of the atoms. This is intentional and prevents the syncer from having to repeatedly return the most recent modification.</li>
</ul>

<p><a name="SpecAdapter"></a></p>

<h4 id="adapter">Adapter</h4>
<p>A LowlaDB adapter is responsible for notifying the syncer whenever documents have been modified. The specifics of this will vary between platforms and even applications. Possible implementations include database triggers, replication log tailing and scheduled polling. In cases where data is only being modified by LowlaDB clients, the adapter can simply notify the syncer as it processes incoming documents from the client.</p>

<p>An adapter notifies the syncer of modifications by issuing an HTTP POST to the endpoint</p>

<p><code>
/api/v1/update
</code></p>

<p>with a request body of the form</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;modified&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;version&gt;&quot;</span><span class="p">,</span>
      <span class="nt">&quot;clientNs&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;clientNs&gt;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="err">...</span><span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;&lt;id1&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;id2&gt;&quot;</span><span class="p">,</span> <span class="err">...</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<p>If the server accepts the notification, it will respond with</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;sequence&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;the current sequence of the syncer after importing the changes&gt;&quot;</span>
<span class="p">}</span></code></pre></div>

<h5 id="notes-2">Notes</h5>
<ul>
  <li>If the adapter does not receive a success response from the syncer, it needs to retry the request.</li>
  <li>The syncer need not use the same sequence for all of the supplied modifications. The syncer attempts to balance the performance cost of generating new sequences against the performance cost of having large numbers of documents sharing the same sequence. In any case, the returned sequence will always be greater than or equal to the largest sequence used during the import.</li>
</ul>

<h2 id="api">API</h2>
<p><a name="API"></a></p>

			  </div>
		  </div>
	  </div>

    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
	<script type="text/javascript">
		$("#navsyncer").addClass("active");
	</script>
	
  </body>
</html>

